<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Solo Trip 2026: Expense Actions</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0F766E; --bg-body: #F8FAFC; --secondary: #F59E0B; }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); -webkit-tap-highlight-color: transparent; height: 100dvh; width: 100vw; overflow: hidden; margin: 0; padding: 0; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .date-chip.active { background-color: var(--primary); color: white; box-shadow: 0 8px 16px -4px rgba(15, 118, 110, 0.3); transform: translateY(-1px); }
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 10; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(100%); }
        .numpad-btn:active { background-color: #e5e7eb; transform: scale(0.95); }

        /* iPhone Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="text-slate-600">

    <div id="app" class="flex flex-col h-full w-full max-w-md mx-auto bg-slate-50 relative shadow-2xl overflow-hidden">

        <header v-if="currentTab !== 'wallet'" class="bg-white pt-safe px-6 flex-none border-b border-slate-100 z-20">
            <div class="pt-2 flex justify-between items-end mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Jamie's Adventure</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-bold bg-teal-50 text-teal-700 px-2 py-0.5 rounded-full">KR</span>
                        <i class="fa-solid fa-arrow-right text-[10px] text-slate-300"></i>
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full">MN</span>
                        <i class="fa-solid fa-arrow-right text-[10px] text-slate-300"></i>
                        <span class="text-[10px] font-bold bg-red-50 text-red-700 px-2 py-0.5 rounded-full">TR</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">ÁõÆÂâçÁ∏ΩËä±Ë≤ª</div>
                    <div class="text-lg font-bold text-teal-700">NT$ {{ formatNumber(totalSpent) }}</div>
                </div>
            </div>
            <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-3">
                <div v-for="date in sortedDates" :key="date" 
                     @click="selectedDate = date"
                     :class="['date-chip flex-none px-5 py-2.5 rounded-2xl text-sm font-bold cursor-pointer border border-slate-100 bg-white text-slate-400 transition-all', selectedDate === date ? 'active' : '']">
                    {{ formatDateShort(date) }}
                </div>
            </div>
        </header>

        <header v-if="currentTab === 'wallet'" class="bg-white pt-safe px-5 flex-none z-20 border-b border-slate-100">
            <div class="pt-2 flex items-center justify-between mb-3">
                <h1 class="text-2xl font-extrabold text-slate-800">Expenses</h1>
                <div class="flex gap-2">
                    <button @click="sortExpenses('date')" class="w-9 h-9 rounded-full bg-slate-50 border border-slate-200 text-slate-500 flex items-center justify-center hover:bg-slate-100 transition">
                        <i class="fa-regular fa-calendar"></i>
                    </button>
                    <button @click="sortExpenses('amount')" class="w-9 h-9 rounded-full bg-slate-50 border border-slate-200 text-slate-500 flex items-center justify-center hover:bg-slate-100 transition">
                        <i class="fa-solid fa-arrow-down-short-wide"></i>
                    </button>
                </div>
            </div>
            <div class="relative mb-3">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                <input type="text" v-model="searchQuery" placeholder="ÊêúÂ∞ãÂïÜÂÆ∂„ÄÅÊ®ôÁ±§..." class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-10 pr-4 text-sm outline-none focus:border-teal-500 transition">
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative w-full bg-slate-50">
            
            <div v-if="currentTab === 'schedule'" class="h-full overflow-y-auto hide-scrollbar px-5 pt-6 pb-20">
                <div class="mb-10 relative">
                    <div class="sticky top-0 z-20 pb-4 pt-2 bg-slate-50/95 backdrop-blur-sm w-full flex justify-between items-center">
                        <div class="flex items-baseline gap-2">
                            <h2 class="text-xl font-bold tracking-tight text-slate-800">{{ formatDateLong(selectedDate) }}</h2>
                            <span class="text-xs font-medium text-slate-400 bg-slate-200/50 px-2 py-1 rounded-md">{{ getDayName(selectedDate) }}</span>
                        </div>
                        <div class="flex gap-2">
                            <div v-if="weather" class="text-xs font-bold text-slate-500 bg-white px-2.5 py-1.5 rounded-lg border border-slate-100 shadow-sm flex items-center">
                                <i class="fa-solid fa-cloud-sun text-orange-400 mr-1.5"></i> {{ weather.temp }}¬∞C
                            </div>
                            <button @click="openAddItineraryModal" class="bg-teal-600 text-white w-8 h-8 rounded-lg shadow-lg flex items-center justify-center hover:bg-teal-700 transition active:scale-95">
                                <i class="fa-solid fa-plus text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div v-if="dailyItinerary.length > 0" class="relative pl-4 ml-2 border-l-2 border-dashed border-gray-300 space-y-6">
                        <div v-for="(item, index) in dailyItinerary" :key="item.id" class="relative group">
                            <div class="absolute top-8 -left-[25px] h-4 w-4 rounded-full bg-slate-50 border-2 flex items-center justify-center z-10" :class="getDotColor(item.type)">
                                <div class="h-1.5 w-1.5 rounded-full" :class="getDotInnerColor(item.type)"></div>
                            </div>
                            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col gap-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex gap-4 w-full">
                                        <div class="h-12 w-12 rounded-2xl flex items-center justify-center shrink-0" :class="getIconBgColor(item.type)">
                                            <i :class="[getItemIcon(item), 'text-lg']" :style="{ color: getIconColor(item.type) }"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-lg font-bold text-slate-800 leading-tight truncate pr-2">{{ item.location }}</h3>
                                            <p class="text-sm text-slate-500 font-medium mt-0.5">{{ item.activity }}</p>
                                            <div v-if="item.note" class="mt-2 flex flex-wrap gap-2">
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-slate-50 text-[11px] font-medium text-slate-500 border border-slate-100">
                                                    <i class="fa-solid fa-circle-info text-slate-300 text-[10px]"></i> {{ item.note }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click.stop="openEditItineraryModal(item)" class="text-slate-300 hover:text-teal-600"><i class="fa-solid fa-pen text-xs"></i></button>
                                            <button @click.stop="deleteItineraryItem(item.id)" class="text-slate-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between pt-3 border-t border-gray-50 mt-1">
                                    <div class="flex items-center gap-2 text-slate-700">
                                        <i class="fa-regular fa-clock text-slate-400 text-sm"></i>
                                        <span class="text-sm font-bold font-mono">{{ item.time }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center py-20 opacity-40">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3 text-slate-300"></i>
                        <p class="text-sm">Êú¨Êó•ÁÑ°Ë°åÁ®ã</p>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full flex flex-col p-6">
                <div class="bg-white p-2 rounded-[2rem] shadow-sm border border-slate-100 flex-1 relative overflow-hidden">
                    <div id="map"></div>
                    <button @click="locateUser" class="absolute bottom-6 right-6 bg-white text-slate-800 w-12 h-12 rounded-full shadow-lg z-[400] flex items-center justify-center hover:text-teal-600 transition">
                        <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    </button>
                </div>
                <div class="mt-4 px-2 flex-none">
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                        <button v-for="item in dailyItinerary" @click="panMapTo(item)" class="flex-none bg-white px-4 py-2.5 rounded-xl text-xs font-bold border border-slate-200 shadow-sm whitespace-nowrap active:bg-teal-50 active:border-teal-200 active:text-teal-700 transition">
                            üìç {{ item.location }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'wallet'" class="h-full w-full flex flex-col relative">
                <div class="flex-1 overflow-y-auto hide-scrollbar px-5 py-2 pb-36">
                    <div class="mb-6">
                        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3 pl-1">È†êÁÆóËàáËä±Ë≤ª</h3>
                        <div class="space-y-3">
                            <div v-for="(exp, idx) in filteredExpenses" :key="exp.id" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 relative group">
                                <div class="flex items-center gap-4 w-full">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-lg shrink-0" :class="getCategoryBg(exp.category)">
                                        <i :class="[getCategoryIcon(exp.category)]" :style="{color: getCategoryColor(exp.category)}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-start mb-0.5">
                                            <h4 class="font-bold text-slate-800 text-[15px] truncate pr-2">{{ exp.item }}</h4>
                                            
                                            <div class="flex flex-col items-end gap-1">
                                                <div class="font-extrabold text-slate-800 text-sm whitespace-nowrap">{{ exp.currency }} {{ formatNumber(exp.original) }}</div>
                                                
                                                <div class="flex items-center gap-3 mt-1">
                                                    <button @click.stop="openEditExpenseModal(exp)" class="text-slate-300 hover:text-teal-600 transition p-1 -m-1">
                                                        <i class="fa-solid fa-pen text-[11px]"></i>
                                                    </button>
                                                    <button @click.stop="deleteExpense(exp.id)" class="text-slate-300 hover:text-red-500 transition p-1 -m-1">
                                                        <i class="fa-solid fa-trash text-[11px]"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-between items-end mt-1">
                                            <div class="flex flex-col gap-1.5 w-full">
                                                <div class="text-[11px] text-slate-400 flex items-center gap-1.5 truncate">
                                                    <span>{{ exp.date }}</span>
                                                    <span class="w-1 h-1 rounded-full bg-slate-300 shrink-0"></span>
                                                    <span>{{ exp.payment }}</span>
                                                </div>
                                                <div class="flex flex-wrap gap-1.5" v-if="exp.tags && exp.tags.length">
                                                    <span v-for="tag in exp.tags" class="text-[10px] font-medium text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded-md whitespace-nowrap">#{{tag}}</span>
                                                </div>
                                            </div>
                                            <div class="text-[11px] font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded-lg shrink-0 whitespace-nowrap ml-2">
                                                ‚âà NT$ {{ formatNumber(exp.twd) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openAddExpenseModal" class="absolute bottom-[110px] right-5 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg shadow-teal-600/30 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-30">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>

                <div class="flex-none bg-white border-t border-slate-100 px-6 py-4 shadow-[0_-4px_20px_-4px_rgba(0,0,0,0.05)] z-20">
                    <div class="flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">ÊóÖÁ®ãÁ∏ΩË®à (TWD)</span>
                            <span class="text-2xl font-bold text-slate-800">NT$ {{ formatNumber(totalSpent) }}</span>
                        </div>
                        <div class="h-8 w-px bg-slate-100 mx-2"></div>
                        <div class="flex flex-col items-end mr-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Ââ©È§òÈ†êÁÆó</span>
                            <span class="text-lg font-bold text-teal-600">NT$ {{ formatNumber(130000 - totalSpent) }}</span>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t border-slate-100 px-8 flex-none z-30 pb-safe pt-2 shadow-[0_-10px_40px_rgba(0,0,0,0.03)]">
            <div class="flex justify-between items-center h-16">
                <button v-for="tab in tabs" @click="currentTab = tab.id" :class="['flex flex-col items-center gap-1.5 transition-all w-16', currentTab === tab.id ? 'text-teal-600 scale-105' : 'text-slate-300']">
                    <i :class="['fa-solid text-xl', tab.icon]"></i>
                    <span class="text-[10px] font-bold">{{ tab.name }}</span>
                </button>
            </div>
        </nav>

        <transition name="modal">
            <div v-if="showItineraryModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
                <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transition-all transform">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold text-slate-400 ml-1">ÊôÇÈñì</label><input type="time" v-model="form.time" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition"></div>
                        <div><label class="text-xs font-bold text-slate-400 ml-1">Âú∞Èªû</label><input type="text" v-model="form.location" placeholder="‰æãÂ¶ÇÔºö‰ºäÊñØÂù¶Â†°Ê©üÂ†¥" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition"></div>
                        <div><label class="text-xs font-bold text-slate-400 ml-1">Ê¥ªÂãïÂÖßÂÆπ</label><input type="text" v-model="form.activity" placeholder="ÂÅö‰ªÄÈ∫ºÔºü" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition"></div>
                        <div><label class="text-xs font-bold text-slate-400 ml-1">È°ûÂûã</label><select v-model="form.type" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option value="visit">üì∑ ÊôØÈªû</option><option value="transport">‚úàÔ∏è ‰∫§ÈÄö</option><option value="stay">üè® ‰ΩèÂÆø</option></select></div>
                        <div><label class="text-xs font-bold text-slate-400 ml-1">ÂÇôË®ª</label><textarea v-model="form.note" rows="2" placeholder="ÂÇôË®ª..." class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition"></textarea></div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="closeItineraryModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">ÂèñÊ∂à</button>
                        <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-teal-600 text-white font-bold text-sm shadow-lg shadow-teal-200">ÂÑ≤Â≠ò</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex flex-col bg-slate-50 h-full w-full">
                <div class="flex items-center justify-between px-5 pt-safe mt-4 pb-2 flex-none">
                    <button @click="closeExpenseModal" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <h3 class="text-lg font-bold text-slate-800">{{ isEditing ? 'Edit Expense' : 'Add Expense' }}</h3>
                    <button @click="saveExpense" class="text-teal-600 font-bold text-base px-2">Save</button>
                </div>

                <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pb-4">
                    <div class="bg-white rounded-3xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] p-6 mb-5 flex flex-col items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-teal-50 rounded-full -mr-10 -mt-10 blur-2xl opacity-60"></div>
                        <div class="relative z-10 flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl mb-2 cursor-pointer border border-slate-100">
                            <div class="w-5 h-5 rounded-full bg-teal-600 text-white flex items-center justify-center text-[10px] font-bold">M</div>
                            <select v-model="expenseForm.currency" class="bg-transparent text-sm font-bold text-slate-700 outline-none appearance-none">
                                <option value="MNT">MNT</option>
                                <option value="KRW">KRW</option>
                                <option value="TRY">TRY</option>
                                <option value="USD">USD</option>
                                <option value="NTD">NTD</option>
                            </select>
                            <i class="fa-solid fa-chevron-down text-[10px] text-slate-400 pointer-events-none"></i>
                        </div>
                        <div class="relative z-10 text-center w-full mb-3">
                            <span class="text-5xl font-bold text-slate-800 tracking-tight">{{ expenseForm.amount || '0' }}</span>
                        </div>
                        <div v-if="expenseForm.amount" class="relative z-10 bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-lg text-sm font-medium border border-yellow-100 flex items-center gap-2 animate-pulse">
                            <i class="fa-solid fa-calculator text-xs"></i>
                            Á¥Ñ TWD {{ calculateTWD }}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <button class="bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm border border-slate-100">
                                <div class="w-8 h-8 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-regular fa-calendar text-sm"></i></div>
                                <span class="text-sm font-medium text-slate-700">Today</span>
                            </button>
                            <button class="bg-white p-3 rounded-2xl flex items-center gap-3 shadow-sm border border-slate-100">
                                <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-pen text-sm"></i></div>
                                <input v-model="expenseForm.item" placeholder="Add note..." class="bg-transparent w-full text-sm outline-none placeholder:text-slate-400 text-slate-700">
                            </button>
                        </div>

                        <div class="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-3 px-1">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Category</span>
                            </div>
                            <div class="grid grid-cols-4 gap-3">
                                <div v-for="cat in categories" :key="cat.id" 
                                     @click="expenseForm.category = cat.id"
                                     :class="['flex flex-col items-center gap-1 cursor-pointer p-2 rounded-xl transition', expenseForm.category === cat.id ? 'bg-teal-50 ring-2 ring-teal-500/20' : 'hover:bg-slate-50']">
                                    <div :class="['w-10 h-10 rounded-xl flex items-center justify-center text-lg transition', expenseForm.category === cat.id ? 'bg-teal-600 text-white shadow-lg shadow-teal-200' : 'bg-slate-100 text-slate-400']">
                                        <i :class="cat.icon"></i>
                                    </div>
                                    <span :class="['text-[10px] font-medium', expenseForm.category === cat.id ? 'text-teal-700' : 'text-slate-400']">{{ cat.name }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-3 shadow-sm border border-slate-100 flex gap-2">
                            <button v-for="method in ['Cash', 'Card', 'Mobile']" 
                                    @click="expenseForm.payment = method"
                                    :class="['flex-1 py-2 rounded-xl text-xs font-bold transition', expenseForm.payment === method ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-50 text-slate-400']">
                                {{ method }}
                            </button>
                        </div>
                        
                        <button class="w-full py-3 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-sm font-medium flex items-center justify-center gap-2 hover:bg-slate-50 hover:border-slate-300 transition">
                            <i class="fa-solid fa-camera"></i> Upload Receipt
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-t-[2.5rem] shadow-[0_-4px_20px_rgba(0,0,0,0.03)] pt-6 pb-8 px-6 z-20 flex-none pb-safe">
                    <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                    <div class="grid grid-cols-3 gap-y-5 gap-x-8">
                        <button v-for="n in [1,2,3,4,5,6,7,8,9]" :key="n" @click="appendNumber(n)" class="numpad-btn text-2xl font-semibold text-slate-800 h-12 rounded-full transition">{{ n }}</button>
                        <button @click="appendNumber('.')" class="numpad-btn text-2xl font-semibold text-slate-800 h-12 rounded-full transition">.</button>
                        <button @click="appendNumber(0)" class="numpad-btn text-2xl font-semibold text-slate-800 h-12 rounded-full transition">0</button>
                        <button @click="backspaceNumber" class="numpad-btn flex items-center justify-center h-12 rounded-full text-slate-800 hover:text-red-500 transition"><i class="fa-solid fa-delete-left text-xl"></i></button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentTab: 'schedule',
                    selectedDate: '2026-04-24',
                    weather: null,
                    searchQuery: '',
                    sortKey: 'date',
                    
                    showItineraryModal: false,
                    showExpenseModal: false,
                    isEditing: false,
                    
                    form: { id: null, time: '', location: '', activity: '', type: 'visit', note: '' },
                    expenseForm: { id: null, amount: '', currency: 'MNT', item: '', category: 'food', payment: 'Cash', tags: [] },

                    rates: { 'NTD': 1, 'KRW': 0.024, 'MNT': 0.0095, 'TRY': 1.1, 'USD': 32.5, 'EUR': 34.5 },
                    categories: [
                        { id: 'transport', name: 'Transport', icon: 'fa-solid fa-plane' },
                        { id: 'food', name: 'Food', icon: 'fa-solid fa-utensils' },
                        { id: 'stay', name: 'Hotel', icon: 'fa-solid fa-bed' },
                        { id: 'shop', name: 'Shop', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'ticket', name: 'Exp.', icon: 'fa-solid fa-ticket' },
                        { id: 'other', name: 'More', icon: 'fa-solid fa-ellipsis' }
                    ],

                    tabs: [
                        { id: 'schedule', name: 'Ë°åÁ®ã', icon: 'fa-layer-group' },
                        { id: 'map', name: 'Âú∞Âúñ', icon: 'fa-map-location-dot' },
                        { id: 'wallet', name: 'Ë®òÂ∏≥', icon: 'fa-wallet' },
                    ],

                    // Expenses Data (With IDs)
                    expenses: [
                         { id: 101, item: 'Ê©üÁ•®: È´òÈõÑ-È¶ñÁàæ', original: 5496, currency: 'NTD', twd: 5496, category: 'transport', date: '4/24', payment: 'Card', tags: ['Flight', 'China Airlines'] },
                         { id: 102, item: 'Ê©üÁ•®: È¶ñÁàæ-ËíôÂè§', original: 120100, currency: 'KRW', twd: 3003, category: 'transport', date: '4/24', payment: 'Card', tags: ['Flight', 'MIAT'] },
                         { id: 103, item: 'Ê©üÁ•®: ËíôÂè§-‰ºäÊñØÂù¶Â†°', original: 1415600, currency: 'KRW', twd: 35390, category: 'transport', date: '4/26', payment: 'Card', tags: ['Flight', 'MIAT'] },
                         { id: 104, item: 'Ê©üÁ•®: IST-ADB', original: 4000, currency: 'NTD', twd: 4000, category: 'transport', date: '4/29', payment: 'Card', tags: ['Flight', 'Turkish'] },
                         { id: 105, item: 'Ê©üÁ•®: ADB-ORK', original: 5000, currency: 'NTD', twd: 5000, category: 'transport', date: '5/2', payment: 'Card', tags: ['Flight', 'SunExpress'] },
                         { id: 106, item: '‰∫§ÈÄö: ËíôÂè§Ê©üÂ†¥Â∑¥Â£´', original: 30000, currency: 'MNT', twd: 300, category: 'transport', date: '4/24', payment: 'Cash', tags: ['Bus'] },
                         { id: 107, item: '‰∫§ÈÄö: ADB-Sel√ßuk', original: 100, currency: 'NTD', twd: 100, category: 'transport', date: '4/29', payment: 'Cash', tags: ['Bus'] },
                         { id: 108, item: '‰∫§ÈÄö: Sel√ßuk-Izmir', original: 150, currency: 'NTD', twd: 150, category: 'transport', date: '4/30', payment: 'Cash', tags: ['Bus'] },
                         { id: 109, item: '‰ΩèÂÆø: ËíôÂè§ (2Êôö)', original: 1600, currency: 'NTD', twd: 1600, category: 'stay', date: '4/24', payment: 'Card', tags: ['Hotel'] },
                         { id: 110, item: 'È´îÈ©ó: ËíôÂè§‰∏ÄÊó•ÈÅä', original: 36, currency: 'USD', twd: 1152, category: 'ticket', date: '4/25', payment: 'Card', tags: ['Tour'] },
                         { id: 111, item: '‰ΩèÂÆø: ‰ºäÊñØÂù¶Â†° (3Êôö)', original: 4500, currency: 'NTD', twd: 4500, category: 'stay', date: '4/26', payment: 'Card', tags: ['Hotel'] },
                         { id: 112, item: '‰ΩèÂÆø: Sel√ßuk (1Êôö)', original: 2000, currency: 'NTD', twd: 2000, category: 'stay', date: '4/29', payment: 'Card', tags: ['Hotel'] },
                         { id: 113, item: '‰ΩèÂÆø: Izmir (1Êôö)', original: 4000, currency: 'NTD', twd: 4000, category: 'stay', date: '4/30', payment: 'Card', tags: ['Hotel'] },
                    ],

                    itinerary: [
                        { id: 1, date: '2026-04-24', time: '08:45', location: 'ÈáúÂ±±ÈáëÊµ∑Ê©üÂ†¥', activity: 'È£õÂæÄÈ¶ñÁàæÈáëÊµ¶ (Â§ßÈüìËà™Á©∫)', type: 'transport', note: '20kgË°åÊùéÁõ¥Êéõ', coords: [35.1796, 129.0756] },
                        { id: 2, date: '2026-04-24', time: '10:30', location: 'ÈáëÊµ¶Ê©üÂ†¥', activity: 'ËΩâ‰πòÂú∞ÈêµËá≥‰ªÅÂ∑ùÊ©üÂ†¥', type: 'transport', note: 'ËΩâÊ©üÊôÇÈñìÁ¥Ñ 40min', coords: [37.5587, 126.7945] },
                        { id: 3, date: '2026-04-24', time: '14:20', location: '‰ªÅÂ∑ùÊ©üÂ†¥', activity: 'È£õÂæÄËíôÂè§ (ËíôÂè§Ëà™Á©∫)', type: 'transport', note: 'Ë°åÊùé23kg+8kg', coords: [37.4602, 126.4407] },
                        { id: 4, date: '2026-04-24', time: '18:00', location: 'ÁÉèËò≠Â∑¥ÊâòÊ©üÂ†¥', activity: 'Êê≠Â∑¥Â£´ X19 Ëá≥Â∏ÇÂçÄ', type: 'transport', note: 'ËªäÁ®ãÁ¥Ñ 2hr', coords: [47.843, 106.764] },
                        { id: 5, date: '2026-04-24', time: '20:30', location: 'ÁÉèËò≠Â∑¥ÊâòÂ∏ÇÂçÄ', activity: 'Check-in È£ØÂ∫ó', type: 'stay', note: 'È†êË®àÂÅúÁïô 2 Êôö', coords: [47.9184, 106.9176] },
                        { id: 6, date: '2026-04-25', time: '09:00', location: 'Terelj National Park', activity: 'ËçâÂéüÈ®éÈ¶¨‰∏ÄÊó•ÈÅä', type: 'visit', note: 'È†êÁ¥Ñ GetYourGuide', coords: [47.9861, 107.4139] },
                        { id: 7, date: '2026-04-26', time: '07:55', location: 'ÁÉèËò≠Â∑¥ÊâòÊ©üÂ†¥', activity: 'È£õÂæÄ‰ºäÊñØÂù¶Â†° (ËíôÂè§Ëà™Á©∫ÂïÜÂãôËâô)', type: 'transport', note: 'ÈúÄÂú®Ê©üÂ†¥ÈÅéÂ§ú', coords: [47.843, 106.764] },
                        { id: 8, date: '2026-04-26', time: '14:00', location: '‰ºäÊñØÂù¶Â†°', activity: 'ÊäµÈÅî‰∏¶ÂÖ•‰ΩèËàäÂüéÂçÄ', type: 'stay', note: 'È†êË®à‰ΩèÂÆø 3 Êôö', coords: [41.0082, 28.9784] },
                        { id: 9, date: '2026-04-27', time: '10:00', location: 'ËÅñÁ¥¢Ëè≤‰∫ûÂ§ßÊïôÂ†Ç', activity: 'Ê≠∑Âè≤ÂüéÂçÄÊé¢Á¥¢', type: 'visit', note: 'Ëá™Áî±Ê¥ªÂãï', coords: [41.0086, 28.9802] },
                        { id: 10, date: '2026-04-28', time: '09:00', location: 'Â§ßÂ∑¥ÊâéÂ∏ÇÈõÜ', activity: 'Ë≥ºÁâ©ËàáÁæéÈ£ü', type: 'visit', note: 'Ë≥ºË≤∑ÂúüËÄ≥ÂÖ∂ËªüÁ≥ñ', coords: [41.0107, 28.9680] },
                        { id: 11, date: '2026-04-29', time: '10:00', location: '‰ºäÊñØÂù¶Â†°Ê©üÂ†¥', activity: 'È£õÂæÄ Izmir (ADB)', type: 'transport', note: 'ÂúüËà™ÂïÜÂãôËâô', coords: [41.2768, 28.7293] },
                        { id: 12, date: '2026-04-29', time: '14:00', location: 'ADB Ê©üÂ†¥', activity: 'ËΩâ‰πòÂ∑¥Â£´Ëá≥ Sel√ßuk', type: 'transport', note: 'ÂÖ¨ËªäÁßªÂãï', coords: [38.2924, 27.157] },
                        { id: 13, date: '2026-04-29', time: '16:00', location: 'Sel√ßuk', activity: 'ÂÖ•‰ΩèÈ£ØÂ∫ó', type: 'stay', note: '‰ΩèÂÆø 1 Êôö', coords: [37.9496, 27.3683] },
                        { id: 14, date: '2026-04-30', time: '10:00', location: 'Sel√ßuk', activity: 'Â∑¥Â£´ÂâçÂæÄ Izmir', type: 'transport', note: 'ËªäÁ®ã 1.5hr', coords: [37.9496, 27.3683] },
                        { id: 15, date: '2026-04-30', time: '13:00', location: 'Izmir', activity: 'ÂÖ•‰ΩèÈ£ØÂ∫ó', type: 'stay', note: '‰ΩèÂÆø 1 Êôö', coords: [38.4237, 27.1428] },
                        { id: 16, date: '2026-05-01', time: '10:00', location: 'Izmir', activity: 'Êµ∑Êø±Êº´Ê≠•ËàáËßÄÂÖâ', type: 'visit', note: 'Ëá™Áî±Ê¥ªÂãï', coords: [38.4237, 27.1428] },
                        { id: 17, date: '2026-05-02', time: '13:00', location: 'ADB Ê©üÂ†¥', activity: 'È£õÂæÄ ORK (Â§™ÈôΩÂø´ÈÅã)', type: 'transport', note: 'ÂâçÂæÄ‰∏ã‰∏ÄÁõÆÁöÑÂú∞', coords: [38.2924, 27.157] }
                    ],
                    
                    map: null,
                    mapMarkers: []
                }
            },
            computed: {
                sortedDates() {
                    return [...new Set(this.itinerary.map(i => i.date))].sort()
                },
                dailyItinerary() {
                    return this.itinerary.filter(i => i.date === this.selectedDate).sort((a,b) => a.time.localeCompare(b.time))
                },
                calculateTWD() {
                    if(!this.expenseForm.amount) return 0;
                    return Math.round(parseFloat(this.expenseForm.amount) * this.rates[this.expenseForm.currency]);
                },
                totalSpent() {
                    return this.expenses.reduce((sum, e) => sum + e.twd, 0);
                },
                filteredExpenses() {
                    let list = this.expenses;
                    if (this.searchQuery) {
                        const lower = this.searchQuery.toLowerCase();
                        list = list.filter(e => 
                            e.item.toLowerCase().includes(lower) || 
                            (e.tags && e.tags.some(t => t.toLowerCase().includes(lower)))
                        );
                    }
                    if (this.sortKey === 'amount') {
                        list = [...list].sort((a, b) => b.twd - a.twd);
                    } else if (this.sortKey === 'date') {
                        list = [...list].sort((a, b) => a.date.localeCompare(b.date));
                    }
                    return list;
                }
            },
            watch: {
                currentTab(val) {
                    if (val === 'map') {
                        setTimeout(() => this.initMap(), 100);
                    }
                },
                selectedDate() {
                    if (this.currentTab === 'map') this.updateMapMarkers();
                    this.fetchWeather();
                }
            },
            mounted() {
                this.fetchWeather();
            },
            methods: {
                openAddExpenseModal() {
                    this.isEditing = false;
                    this.expenseForm = { id: null, amount: '', currency: 'MNT', item: '', category: 'food', payment: 'Cash', tags: [] };
                    this.showExpenseModal = true;
                },
                openEditExpenseModal(exp) {
                    this.isEditing = true;
                    this.expenseForm = { ...exp, amount: exp.original.toString() }; 
                    this.showExpenseModal = true;
                },
                deleteExpense(id) {
                    if(confirm("Á¢∫ÂÆöÂà™Èô§ÈÄôÁ≠ÜÊîØÂá∫ÂóéÔºü")) {
                        this.expenses = this.expenses.filter(e => e.id !== id);
                    }
                },
                closeExpenseModal() {
                    this.showExpenseModal = false;
                },
                appendNumber(num) {
                    if (num === '.' && this.expenseForm.amount.includes('.')) return;
                    if (this.expenseForm.amount.length > 8) return;
                    this.expenseForm.amount += num.toString();
                },
                backspaceNumber() {
                    this.expenseForm.amount = this.expenseForm.amount.slice(0, -1);
                },
                saveExpense() {
                    if (!this.expenseForm.amount) return;
                    
                    const newItem = {
                        item: this.expenseForm.item || 'Êú™ÂëΩÂêçÊ∂àË≤ª',
                        original: parseFloat(this.expenseForm.amount),
                        currency: this.expenseForm.currency,
                        twd: this.calculateTWD,
                        category: this.expenseForm.category,
                        date: 'Today, Now',
                        payment: this.expenseForm.payment,
                        tags: this.expenseForm.tags
                    };

                    if (this.isEditing && this.expenseForm.id) {
                        // Edit Mode
                        const idx = this.expenses.findIndex(e => e.id === this.expenseForm.id);
                        if (idx !== -1) {
                            this.expenses[idx] = { ...this.expenses[idx], ...newItem };
                        }
                    } else {
                        // Add Mode
                        this.expenses.unshift({ ...newItem, id: Date.now() });
                    }
                    this.closeExpenseModal();
                },
                sortExpenses(key) {
                    this.sortKey = key;
                },
                getCategoryIcon(catId) {
                    const cat = this.categories.find(c => c.id === catId);
                    return cat ? cat.icon : 'fa-solid fa-bag-shopping';
                },
                getCategoryColor(catId) {
                    const colors = { transport: '#0D9488', food: '#0891b2', stay: '#EAB308', shop: '#F97316', other: '#64748B' };
                    return colors[catId] || '#64748B';
                },
                getCategoryBg(catId) {
                    const bgs = { transport: 'bg-teal-50', food: 'bg-cyan-50', stay: 'bg-yellow-50', shop: 'bg-orange-50', other: 'bg-slate-50' };
                    return bgs[catId] || 'bg-slate-50';
                },

                getDotColor(type) {
                    if(type === 'transport') return 'border-teal-600';
                    if(type === 'stay') return 'border-yellow-500';
                    return 'border-orange-500'; 
                },
                getDotInnerColor(type) {
                    if(type === 'transport') return 'bg-teal-600';
                    if(type === 'stay') return 'bg-yellow-500';
                    return 'bg-orange-500';
                },
                getIconBgColor(type) {
                    if(type === 'transport') return 'bg-teal-50';
                    if(type === 'stay') return 'bg-yellow-50';
                    return 'bg-orange-50';
                },
                getIconColor(type) {
                    if(type === 'transport') return '#0D9488'; 
                    if(type === 'stay') return '#EAB308'; 
                    return '#F97316'; 
                },
                getItemIcon(item) {
                    if(item.type === 'transport') {
                        if(item.activity.includes('È£õ')) return 'fa-solid fa-plane-departure';
                        if(item.activity.includes('Â∑¥Â£´')) return 'fa-solid fa-bus';
                        return 'fa-solid fa-route';
                    }
                    if(item.type === 'stay') return 'fa-solid fa-bed';
                    if(item.location.includes('Ê©üÂ†¥')) return 'fa-solid fa-plane';
                    return 'fa-solid fa-camera';
                },
                
                formatDateShort(dateStr) {
                    const d = new Date(dateStr);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                },
                formatDateLong(dateStr) {
                    const d = new Date(dateStr);
                    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
                },
                getDayName(dateStr) {
                    const d = new Date(dateStr);
                    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    return days[d.getDay()];
                },
                formatNumber(num) {
                    return new Intl.NumberFormat('zh-TW').format(num);
                },
                formatNote(note) {
                    return note ? note.replace(/\n/g, '<br>') : '';
                },
                
                async fetchWeather() {
                    const firstItem = this.dailyItinerary[0];
                    if (!firstItem || !firstItem.coords) { this.weather = null; return; }
                    
                    const [lat, lng] = firstItem.coords;
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                        const data = await res.json();
                        this.weather = {
                            temp: Math.round(data.current_weather.temperature)
                        };
                    } catch (e) {
                        console.error("Weather error:", e);
                    }
                },

                openAddItineraryModal() {
                    this.isEditing = false;
                    this.form = { id: null, time: '', location: '', activity: '', type: 'visit', note: '' };
                    this.showItineraryModal = true;
                },
                openEditItineraryModal(item) {
                    this.isEditing = true;
                    this.form = { ...item };
                    this.showItineraryModal = true;
                },
                deleteItineraryItem(id) {
                    if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºü')) {
                        this.itinerary = this.itinerary.filter(i => i.id !== id);
                        if(this.currentTab === 'map') this.updateMapMarkers();
                    }
                },
                saveItineraryItem() {
                    if (!this.form.location) { alert('Ë´ãËº∏ÂÖ•Âú∞Èªû'); return; }
                    
                    if (this.isEditing) {
                        const idx = this.itinerary.findIndex(i => i.id === this.form.id);
                        if (idx !== -1) this.itinerary[idx] = { ...this.itinerary[idx], ...this.form };
                    } else {
                        const currentDayItems = this.dailyItinerary;
                        const defaultCoords = currentDayItems.length > 0 ? currentDayItems[0].coords : [47.9, 106.9];
                        
                        this.itinerary.push({
                            ...this.form,
                            id: Date.now(),
                            date: this.selectedDate,
                            coords: defaultCoords
                        });
                    }
                    this.showItineraryModal = false;
                    this.fetchWeather();
                    if(this.currentTab === 'map') this.updateMapMarkers();
                },
                closeItineraryModal() { this.showItineraryModal = false; },

                initMap() {
                    if (this.map) {
                        this.updateMapMarkers();
                        this.map.invalidateSize();
                        return;
                    }
                    this.map = L.map('map').setView([47.9, 106.9], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(this.map);
                    this.updateMapMarkers();
                },
                updateMapMarkers() {
                    if (!this.map) return;
                    this.mapMarkers.forEach(m => this.map.removeLayer(m));
                    this.mapMarkers = [];
                    const points = [];
                    this.dailyItinerary.forEach(item => {
                        if (item.coords) {
                            const marker = L.marker(item.coords)
                                .bindPopup(`<b>${item.location}</b><br>${item.time} ${item.activity}`)
                                .addTo(this.map);
                            this.mapMarkers.push(marker);
                            points.push(item.coords);
                        }
                    });
                    if (points.length > 0) this.map.fitBounds(points, { padding: [50, 50] });
                },
                panMapTo(item) {
                    if(this.map && item.coords) {
                        this.map.flyTo(item.coords, 14);
                        this.mapMarkers.find(m => m.getLatLng().lat === item.coords[0])?.openPopup();
                    }
                },
                locateUser() {
                    if (this.map) {
                        this.map.locate({setView: true, maxZoom: 16});
                        this.map.on('locationfound', e => {
                            L.circle(e.latlng, {radius: 50, color: 'blue'}).addTo(this.map).bindPopup("‰Ω†Âú®ÈÄôË£°").openPopup();
                        });
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
