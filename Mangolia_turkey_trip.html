<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solo Trip 2026: å®Œæ•´ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0F766E; --bg-body: #F8FAFC; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* æ—¥æœŸé¸å–® Active ç‹€æ…‹ */
        .date-chip.active { background-color: var(--primary); color: white; box-shadow: 0 8px 16px -4px rgba(15, 118, 110, 0.3); transform: translateY(-1px); }
        
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 10; }
        
        /* Modal å‹•ç•« */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-slate-600 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-slate-50 relative shadow-2xl">

        <header class="bg-white pt-10 pb-4 px-6 rounded-b-[2rem] shadow-sm z-20 flex-none border-b border-slate-100">
            <div class="flex justify-between items-end mb-5">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Jamie's advanture</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-bold bg-teal-50 text-teal-700 px-2 py-0.5 rounded-full">KR</span>
                        <i class="fa-solid fa-arrow-right text-[10px] text-slate-300"></i>
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full">MN</span>
                        <i class="fa-solid fa-arrow-right text-[10px] text-slate-300"></i>
                        <span class="text-[10px] font-bold bg-red-50 text-red-700 px-2 py-0.5 rounded-full">TR</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">ç›®å‰ç¸½èŠ±è²»</div>
                    <div class="text-lg font-bold text-teal-700">NT$ {{ formatNumber(totalSpent) }}</div>
                </div>
            </div>

            <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                <div v-for="date in sortedDates" :key="date" 
                     @click="selectedDate = date"
                     :class="['date-chip flex-none px-5 py-2.5 rounded-2xl text-sm font-bold cursor-pointer border border-slate-100 bg-white text-slate-400 transition-all', selectedDate === date ? 'active' : '']">
                    {{ formatDateShort(date) }}
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scrollbar p-6 space-y-6 relative pb-24">
            
            <div v-if="currentTab === 'schedule'" class="space-y-4">
                <div class="flex justify-between items-center px-1 mb-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-slate-800">ä»Šæ—¥å®‰æ’</h2>
                        <div v-if="weather" class="text-xs font-medium text-slate-500 bg-white px-2 py-1 rounded-full border border-slate-100 flex items-center shadow-sm">
                            <i class="fa-solid fa-cloud-sun text-orange-400 mr-1"></i> {{ weather.temp }}Â°C
                        </div>
                    </div>
                    <button @click="openAddModal" class="bg-teal-600 text-white w-8 h-8 rounded-full shadow-lg flex items-center justify-center hover:bg-teal-700 transition active:scale-90">
                        <i class="fa-solid fa-plus text-sm"></i>
                    </button>
                </div>

                <div v-if="dailyItinerary.length > 0" class="space-y-4">
                    <div v-for="item in dailyItinerary" :key="item.id" class="glass-card rounded-3xl p-5 relative overflow-hidden group transition-all hover:translate-y-[-2px]">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="getTypeColor(item.type)"></div>
                        
                        <div class="pl-3">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-black font-mono text-slate-400 bg-slate-100 px-2 py-1 rounded-lg tracking-tight">{{ item.time }}</span>
                                <div class="flex gap-3 opacity-80">
                                    <button @click="openEditModal(item)" class="text-slate-300 hover:text-teal-600 transition"><i class="fa-solid fa-pen text-xs"></i></button>
                                    <button @click="deleteItem(item.id)" class="text-slate-300 hover:text-red-400 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            
                            <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight">{{ item.location }}</h3>
                            <p class="text-sm text-slate-600 font-medium mb-2">{{ item.activity }}</p>
                            
                            <div v-if="item.note" class="bg-slate-50 p-3 rounded-xl text-xs text-slate-500 leading-relaxed border border-slate-100 mt-2">
                                <i class="fa-solid fa-circle-info text-teal-400 mr-1"></i> 
                                <span v-html="formatNote(item.note)"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="text-center py-16 opacity-40">
                    <i class="fa-solid fa-mug-hot text-4xl mb-3 text-slate-300"></i>
                    <p class="text-sm">æœ¬æ—¥ç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢</p>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full flex flex-col">
                <div class="bg-white p-2 rounded-[2rem] shadow-sm border border-slate-100 flex-1 relative overflow-hidden">
                    <div id="map"></div>
                    <button @click="locateUser" class="absolute bottom-6 right-6 bg-white text-slate-800 w-12 h-12 rounded-full shadow-lg z-[400] flex items-center justify-center hover:text-teal-600 transition">
                        <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    </button>
                </div>
                <div class="mt-4 px-2">
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                        <button v-for="item in dailyItinerary" @click="panMapTo(item)" class="flex-none bg-white px-4 py-2.5 rounded-xl text-xs font-bold border border-slate-200 shadow-sm whitespace-nowrap active:bg-teal-50 active:border-teal-200 active:text-teal-700 transition">
                            ğŸ“ {{ item.location }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'wallet'" class="space-y-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-[2rem] shadow-xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-teal-500 opacity-20 rounded-full blur-2xl"></div>
                    <div class="relative z-10">
                        <div class="text-3xl font-bold mb-4">NT$ {{ formatNumber(totalSpent) }}</div>
                        <div class="text-xs opacity-50 uppercase tracking-widest">Total Expenses</div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">å¿«é€Ÿè¨˜å¸³</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="number" v-model="expenseForm.amount" placeholder="é‡‘é¡" class="w-2/3 bg-slate-50 border-none rounded-xl px-4 py-3 font-bold outline-none focus:ring-2 ring-teal-500">
                        <select v-model="expenseForm.currency" class="w-1/3 bg-slate-50 border-none rounded-xl px-2 py-3 text-sm font-bold outline-none">
                            <option value="MNT">ğŸ‡²ğŸ‡³ è’™åœ–</option>
                            <option value="TRY">ğŸ‡¹ğŸ‡· é‡Œæ‹‰</option>
                            <option value="KRW">ğŸ‡°ğŸ‡· éŸ“å…ƒ</option>
                            <option value="USD">ğŸ‡ºğŸ‡¸ ç¾é‡‘</option>
                            <option value="NTD">ğŸ‡¹ğŸ‡¼ å°å¹£</option>
                        </select>
                    </div>
                    <input type="text" v-model="expenseForm.item" placeholder="é …ç›®" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm mb-4 outline-none">
                    <button @click="addExpense" class="w-full bg-teal-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-teal-200">åŠ å…¥ (ç´„ NT$ {{ calculateTWD }})</button>
                </div>

                <div class="space-y-3 pb-8">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 text-sm">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div>
                                <div class="text-[10px] text-slate-400 font-mono">{{ exp.currency }} {{ formatNumber(exp.original) }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-slate-800 text-sm">NT$ {{ formatNumber(exp.twd) }}</div>
                            <button @click="expenses.splice(idx, 1)" class="text-[10px] text-red-300 mt-1">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'translate'" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <button @click="transLang = 'mn'" :class="['p-4 rounded-2xl border text-center transition', transLang === 'mn' ? 'bg-teal-600 text-white border-teal-600 shadow-lg shadow-teal-200' : 'bg-white border-slate-100 text-slate-400']">
                        <div class="text-2xl mb-1">ğŸ‡²ğŸ‡³</div>
                        <div class="text-xs font-bold">è’™å¤èª</div>
                    </button>
                    <button @click="transLang = 'tr'" :class="['p-4 rounded-2xl border text-center transition', transLang === 'tr' ? 'bg-teal-600 text-white border-teal-600 shadow-lg shadow-teal-200' : 'bg-white border-slate-100 text-slate-400']">
                        <div class="text-2xl mb-1">ğŸ‡¹ğŸ‡·</div>
                        <div class="text-xs font-bold">åœŸè€³å…¶èª</div>
                    </button>
                </div>
                <div class="space-y-3">
                    <div v-for="phrase in phrases" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm" @click="alertText(phrase)">
                        <div class="text-xs text-slate-400 mb-1">{{ phrase.tw }}</div>
                        <div class="text-xl font-bold text-slate-800">{{ transLang === 'mn' ? phrase.mn : phrase.tr }}</div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-slate-100 px-8 h-[85px] flex justify-between items-center flex-none z-30 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.03)]">
            <button v-for="tab in tabs" @click="currentTab = tab.id" :class="['flex flex-col items-center gap-1.5 transition-all w-16', currentTab === tab.id ? 'text-teal-600 scale-105' : 'text-slate-300']">
                <i :class="['fa-solid text-xl', tab.icon]"></i>
                <span class="text-[10px] font-bold">{{ tab.name }}</span>
            </button>
        </nav>

        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
                <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transition-all transform">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-400 ml-1">æ™‚é–“</label>
                            <input type="time" v-model="form.time" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 ml-1">åœ°é»</label>
                            <input type="text" v-model="form.location" placeholder="ä¾‹å¦‚ï¼šä¼Šæ–¯å¦å ¡æ©Ÿå ´" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 ml-1">æ´»å‹•å…§å®¹</label>
                            <input type="text" v-model="form.activity" placeholder="åšä»€éº¼ï¼Ÿ" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 ml-1">é¡å‹</label>
                            <select v-model="form.type" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none">
                                <option value="visit">ğŸ“· æ™¯é»</option>
                                <option value="transport">âœˆï¸ äº¤é€š</option>
                                <option value="stay">ğŸ¨ ä½å®¿</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 ml-1">å‚™è¨»</label>
                            <textarea v-model="form.note" rows="2" placeholder="å‚™è¨»..." class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none focus:ring-2 ring-teal-500 transition"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                        <button @click="saveItem" class="flex-1 py-3 rounded-xl bg-teal-600 text-white font-bold text-sm shadow-lg shadow-teal-200">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentTab: 'schedule',
                    selectedDate: '2026-04-24',
                    weather: null,
                    transLang: 'mn',
                    
                    // Modal ç‹€æ…‹
                    showModal: false,
                    isEditing: false,
                    form: { id: null, time: '', location: '', activity: '', type: 'visit', note: '' },

                    rates: { 'NTD': 1, 'KRW': 0.024, 'MNT': 0.0095, 'TRY': 1.1, 'USD': 32.5, 'EUR': 34.5 },
                    expenseForm: { amount: '', currency: 'MNT', item: '' },

                    tabs: [
                        { id: 'schedule', name: 'è¡Œç¨‹', icon: 'fa-layer-group' },
                        { id: 'map', name: 'åœ°åœ–', icon: 'fa-map-location-dot' },
                        { id: 'wallet', name: 'è¨˜å¸³', icon: 'fa-wallet' },
                        { id: 'translate', name: 'ç¿»è­¯', icon: 'fa-language' },
                    ],

                    phrases: [
                        { tw: 'ä½ å¥½', mn: 'Sain baina uu', tr: 'Merhaba' },
                        { tw: 'è¬è¬', mn: 'Bayarlalaa', tr: 'TeÅŸekkÃ¼rler' },
                        { tw: 'å¥½åƒ', mn: 'Amttai', tr: 'Lezzetli' },
                        { tw: 'é€™å€‹å¤šå°‘éŒ¢?', mn: 'Ene khed ve?', tr: 'Bu ne kadar?' },
                        { tw: 'å»æ‰€åœ¨å“ª?', mn: 'Noil haana ve?', tr: 'Tuvalet nerede?' }
                    ],

                    // å®Œæ•´è¨˜å¸³è³‡æ–™ (ä¾æ“š CSV)
                    expenses: [
                         { item: 'æ©Ÿç¥¨: é«˜é›„-é¦–çˆ¾', original: 5496, currency: 'NTD', twd: 5496, category: 'transport' },
                         { item: 'æ©Ÿç¥¨: é¦–çˆ¾-è’™å¤', original: 120100, currency: 'KRW', twd: 3003, category: 'transport' },
                         { item: 'æ©Ÿç¥¨: è’™å¤-ä¼Šæ–¯å¦å ¡', original: 1415600, currency: 'KRW', twd: 35390, category: 'transport' },
                         { item: 'è’™å¤æ©Ÿå ´å·´å£«', original: 15000, currency: 'MNT', twd: 150, category: 'transport' },
                         { item: 'è’™å¤ä½å®¿ (2æ™š)', original: 1600, currency: 'NTD', twd: 1600, category: 'stay' },
                         { item: 'Terelj ä¸€æ—¥éŠ', original: 36, currency: 'USD', twd: 1152, category: 'stay' },
                         { item: 'æ©Ÿç¥¨: IST-ADB', original: 4000, currency: 'NTD', twd: 4000, category: 'transport' },
                         { item: 'ä¼Šæ–¯å¦å ¡ä½å®¿ (3æ™š)', original: 4500, currency: 'NTD', twd: 4500, category: 'stay' },
                         { item: 'SelÃ§uk äº¤é€š', original: 100, currency: 'NTD', twd: 100, category: 'transport' },
                         { item: 'SelÃ§uk ä½å®¿', original: 2000, currency: 'NTD', twd: 2000, category: 'stay' },
                         { item: 'Izmir ä½å®¿', original: 4000, currency: 'NTD', twd: 4000, category: 'stay' },
                         { item: 'æ©Ÿç¥¨: ADB-ORK', original: 5000, currency: 'NTD', twd: 5000, category: 'transport' }
                    ],

                    // å®Œæ•´è¡Œç¨‹è³‡æ–™ (ä¾æ“š CSV/PDF 4/24 - 5/2)
                    itinerary: [
                        // 4/24
                        { id: 1, date: '2026-04-24', time: '08:45', location: 'é‡œå±±é‡‘æµ·æ©Ÿå ´', activity: 'é£›å¾€é¦–çˆ¾é‡‘æµ¦ (å¤§éŸ“èˆªç©º)', type: 'transport', note: '20kgè¡Œæç›´æ›', coords: [35.1796, 129.0756] },
                        { id: 2, date: '2026-04-24', time: '10:30', location: 'é‡‘æµ¦æ©Ÿå ´', activity: 'è½‰ä¹˜åœ°éµè‡³ä»å·æ©Ÿå ´', type: 'transport', note: 'è½‰æ©Ÿæ™‚é–“ç´„ 40min', coords: [37.5587, 126.7945] },
                        { id: 3, date: '2026-04-24', time: '14:20', location: 'ä»å·æ©Ÿå ´', activity: 'é£›å¾€è’™å¤ (è’™å¤èˆªç©º)', type: 'transport', note: 'è¡Œæ23kg+8kg', coords: [37.4602, 126.4407] },
                        { id: 4, date: '2026-04-24', time: '18:00', location: 'çƒè˜­å·´æ‰˜æ©Ÿå ´', activity: 'æ­å·´å£« X19 è‡³å¸‚å€', type: 'transport', note: 'è»Šç¨‹ç´„ 2hr', coords: [47.843, 106.764] },
                        { id: 5, date: '2026-04-24', time: '20:30', location: 'çƒè˜­å·´æ‰˜å¸‚å€', activity: 'Check-in é£¯åº—', type: 'stay', note: 'é è¨ˆåœç•™ 2 æ™š', coords: [47.9184, 106.9176] },
                        // 4/25
                        { id: 6, date: '2026-04-25', time: '09:00', location: 'Terelj National Park', activity: 'è‰åŸé¨é¦¬ä¸€æ—¥éŠ', type: 'visit', note: 'é ç´„ GetYourGuide', coords: [47.9861, 107.4139] },
                        // 4/26
                        { id: 7, date: '2026-04-26', time: '07:55', location: 'çƒè˜­å·´æ‰˜æ©Ÿå ´', activity: 'é£›å¾€ä¼Šæ–¯å¦å ¡ (è’™å¤èˆªç©ºå•†å‹™è‰™)', type: 'transport', note: 'éœ€åœ¨æ©Ÿå ´éå¤œ', coords: [47.843, 106.764] },
                        { id: 8, date: '2026-04-26', time: '14:00', location: 'ä¼Šæ–¯å¦å ¡', activity: 'æŠµé”ä¸¦å…¥ä½èˆŠåŸå€', type: 'stay', note: 'é è¨ˆä½å®¿ 3 æ™š', coords: [41.0082, 28.9784] },
                        // 4/27
                        { id: 9, date: '2026-04-27', time: '10:00', location: 'è–ç´¢è²äºå¤§æ•™å ‚', activity: 'æ­·å²åŸå€æ¢ç´¢', type: 'visit', note: 'è‡ªç”±æ´»å‹•', coords: [41.0086, 28.9802] },
                        // 4/28
                        { id: 10, date: '2026-04-28', time: '09:00', location: 'å¤§å·´æ‰å¸‚é›†', activity: 'è³¼ç‰©èˆ‡ç¾é£Ÿ', type: 'visit', note: 'è³¼è²·åœŸè€³å…¶è»Ÿç³–', coords: [41.0107, 28.9680] },
                        // 4/29
                        { id: 11, date: '2026-04-29', time: '10:00', location: 'ä¼Šæ–¯å¦å ¡æ©Ÿå ´', activity: 'é£›å¾€ Izmir (ADB)', type: 'transport', note: 'åœŸèˆªå•†å‹™è‰™', coords: [41.2768, 28.7293] },
                        { id: 12, date: '2026-04-29', time: '14:00', location: 'ADB æ©Ÿå ´', activity: 'è½‰ä¹˜å·´å£«è‡³ SelÃ§uk', type: 'transport', note: 'å…¬è»Šç§»å‹•', coords: [38.2924, 27.157] },
                        { id: 13, date: '2026-04-29', time: '16:00', location: 'SelÃ§uk', activity: 'å…¥ä½é£¯åº—', type: 'stay', note: 'ä½å®¿ 1 æ™š', coords: [37.9496, 27.3683] },
                        // 4/30
                        { id: 14, date: '2026-04-30', time: '10:00', location: 'SelÃ§uk', activity: 'å·´å£«å‰å¾€ Izmir', type: 'transport', note: 'è»Šç¨‹ 1.5hr', coords: [37.9496, 27.3683] },
                        { id: 15, date: '2026-04-30', time: '13:00', location: 'Izmir', activity: 'å…¥ä½é£¯åº—', type: 'stay', note: 'ä½å®¿ 1 æ™š', coords: [38.4237, 27.1428] },
                        // 5/1
                        { id: 16, date: '2026-05-01', time: '10:00', location: 'Izmir', activity: 'æµ·æ¿±æ¼«æ­¥èˆ‡è§€å…‰', type: 'visit', note: 'è‡ªç”±æ´»å‹•', coords: [38.4237, 27.1428] },
                        // 5/2
                        { id: 17, date: '2026-05-02', time: '13:00', location: 'ADB æ©Ÿå ´', activity: 'é£›å¾€ ORK (å¤ªé™½å¿«é‹)', type: 'transport', note: 'å‰å¾€ä¸‹ä¸€ç›®çš„åœ°', coords: [38.2924, 27.157] }
                    ],
                    
                    map: null,
                    mapMarkers: []
                }
            },
            computed: {
                sortedDates() {
                    return [...new Set(this.itinerary.map(i => i.date))].sort()
                },
                dailyItinerary() {
                    return this.itinerary.filter(i => i.date === this.selectedDate).sort((a,b) => a.time.localeCompare(b.time))
                },
                calculateTWD() {
                    if(!this.expenseForm.amount) return 0;
                    return Math.round(this.expenseForm.amount * this.rates[this.expenseForm.currency]);
                },
                totalSpent() {
                    return this.expenses.reduce((sum, e) => sum + e.twd, 0);
                }
            },
            watch: {
                currentTab(val) {
                    if (val === 'map') {
                        setTimeout(() => this.initMap(), 100);
                    }
                },
                selectedDate() {
                    if (this.currentTab === 'map') this.updateMapMarkers();
                    this.fetchWeather();
                }
            },
            mounted() {
                this.fetchWeather();
            },
            methods: {
                getTypeColor(type) {
                    if(type === 'transport') return 'bg-blue-400';
                    if(type === 'stay') return 'bg-purple-400';
                    return 'bg-teal-500';
                },
                getCategoryIcon(cat) {
                    if(cat === 'transport') return 'fa-solid fa-plane';
                    if(cat === 'stay') return 'fa-solid fa-bed';
                    return 'fa-solid fa-bag-shopping';
                },
                formatDateShort(dateStr) {
                    const d = new Date(dateStr);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                },
                formatNumber(num) {
                    return new Intl.NumberFormat('zh-TW').format(num);
                },
                formatNote(note) {
                    return note ? note.replace(/\n/g, '<br>') : '';
                },
                
                // Weather Logic
                async fetchWeather() {
                    const firstItem = this.dailyItinerary[0];
                    if (!firstItem || !firstItem.coords) { this.weather = null; return; }
                    
                    const [lat, lng] = firstItem.coords;
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                        const data = await res.json();
                        this.weather = data.current_weather;
                    } catch (e) {
                        console.error(e);
                    }
                },

                // CRUD Logic
                openAddModal() {
                    this.isEditing = false;
                    this.form = { id: null, time: '', location: '', activity: '', type: 'visit', note: '' };
                    this.showModal = true;
                },
                openEditModal(item) {
                    this.isEditing = true;
                    this.form = { ...item };
                    this.showModal = true;
                },
                deleteItem(id) {
                    if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                        this.itinerary = this.itinerary.filter(i => i.id !== id);
                        if(this.currentTab === 'map') this.updateMapMarkers();
                    }
                },
                saveItem() {
                    if (!this.form.location) { alert('è«‹è¼¸å…¥åœ°é»'); return; }
                    
                    if (this.isEditing) {
                        const idx = this.itinerary.findIndex(i => i.id === this.form.id);
                        if (idx !== -1) this.itinerary[idx] = { ...this.itinerary[idx], ...this.form };
                    } else {
                        // æ–°å¢è¡Œç¨‹æ™‚ï¼Œé è¨­ä½¿ç”¨ç•¶å¤©ç¬¬ä¸€å€‹æ™¯é»çš„åº§æ¨™ï¼Œé¿å…åœ°åœ–å ±éŒ¯
                        const currentDayItems = this.dailyItinerary;
                        const defaultCoords = currentDayItems.length > 0 ? currentDayItems[0].coords : [47.9, 106.9];
                        
                        this.itinerary.push({
                            ...this.form,
                            id: Date.now(),
                            date: this.selectedDate,
                            coords: defaultCoords
                        });
                    }
                    this.showModal = false;
                    this.fetchWeather();
                    if(this.currentTab === 'map') this.updateMapMarkers();
                },
                closeModal() { this.showModal = false; },

                // Expenses Logic
                addExpense() {
                    if (!this.expenseForm.amount) return;
                    this.expenses.unshift({
                        item: this.expenseForm.item || 'æœªå‘½å',
                        original: parseFloat(this.expenseForm.amount),
                        currency: this.expenseForm.currency,
                        twd: this.calculateTWD,
                        category: 'other'
                    });
                    this.expenseForm.amount = '';
                    this.expenseForm.item = '';
                },

                // Map Logic
                initMap() {
                    if (this.map) {
                        this.updateMapMarkers();
                        this.map.invalidateSize();
                        return;
                    }
                    this.map = L.map('map').setView([47.9, 106.9], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(this.map);
                    this.updateMapMarkers();
                },
                updateMapMarkers() {
                    if (!this.map) return;
                    this.mapMarkers.forEach(m => this.map.removeLayer(m));
                    this.mapMarkers = [];
                    const points = [];
                    this.dailyItinerary.forEach(item => {
                        if (item.coords) {
                            const marker = L.marker(item.coords)
                                .bindPopup(`<b>${item.location}</b><br>${item.time} ${item.activity}`)
                                .addTo(this.map);
                            this.mapMarkers.push(marker);
                            points.push(item.coords);
                        }
                    });
                    if (points.length > 0) this.map.fitBounds(points, { padding: [50, 50] });
                },
                panMapTo(item) {
                    if(this.map && item.coords) {
                        this.map.flyTo(item.coords, 14);
                        this.mapMarkers.find(m => m.getLatLng().lat === item.coords[0])?.openPopup();
                    }
                },
                locateUser() {
                    if (this.map) {
                        this.map.locate({setView: true, maxZoom: 16});
                        this.map.on('locationfound', e => {
                            L.circle(e.latlng, {radius: 50, color: 'blue'}).addTo(this.map).bindPopup("ä½ åœ¨é€™è£¡").openPopup();
                        });
                    }
                },
                alertText(phrase) {
                    alert(`è«‹å±•ç¤ºçµ¦åº—å“¡çœ‹ï¼š\n\n${this.transLang === 'mn' ? phrase.mn : phrase.tr}`);
                }
            }
        }).mount('#app')
    </script>
</body>
</html>